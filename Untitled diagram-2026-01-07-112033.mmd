flowchart TD
    %% ==================== SYSTÈME COMPLET ====================
    
    %% ========== 1. INITIALISATION ==========
    A([Démarrage STM32]) --> B
    
    subgraph B[Initialisation Matériel]
        direction LR
        B1[HAL Init]
        B2[Clock]
        B3[ADC1 + DMA circulaire]
        B4[TIM2 - Trigger 100Hz]
        B5[I2C1 - RTC]
        B6[SPI2 - FRAM 1Mb]
        B7[ETH - LwIP]
        B8[USART3 115200 bauds]
        B9[GPIO - Bouton + 3 LEDs]
    end
    
    B --> C
    
    subgraph C[FreeRTOS Initialisation]
        direction TB
        C1[Mutex: uart, data, rtc, node]
        C2[Sémaphore: adcReady]
        C3[File: messageQueue 64 slots]
        C4[Tâches créées]
        C5[Tâches suspendues]
        C6[osKernelStart]
    end
    
    C --> D[defaultTask - Priorité Normal]
    
    %% ========== 2. DÉMARRAGE SYSTÈME ==========
    subgraph D[defaultTask - Gestion Système]
        D1[MX_LWIP_Init]
        D1 --> D2{Attente DHCP}
        D2 -->|Timeout| D3[Retry]
        D2 -->|Succès| D4[IP obtenue]
        
        D4 --> D5{Synchronisation NTP}
        D5 -->|Essais 1-15| D6[Sync_Time_NTP]
        D6 --> D7{ntp_synced?}
        D7 -->|OUI| D8[RTC synchronisé]
        D7 -->|NON| D9[Heure locale RTC]
        
        D8 & D9 --> D10[Système prêt]
        D10 --> D11{Bouton Bleu}
        
        D11 -->|NON| D12[Delay 100ms]
        D12 --> D11
        
        D11 -->|OUI - START| D13[SYSTEM STARTED]
        D11 -->|OUI - STOP| D14[SYSTEM STOPPED]
    end
    
    %% ========== 3. MODE MARCHE ==========
    subgraph E[Système Actif - system_is_running = 1]
        E1[UDP RX Listener activé]
        E2[Lecture FRAM historique]
        E3[Reprise toutes tâches]
        
        subgraph E4[Réseau - Présence]
            E5[Toutes 10s: UDP Broadcast]
            E6[JSON: type=presence, id, ip, timestamp]
            E7[Port 12345 - Adresse broadcast]
            E5 --> E6 --> E7 --> E5
        end
        
        subgraph E8[Réseau - Réception]
            E9[Écoute UDP port 12345]
            E10[Réception presence voisins]
            E11[Mise à jour dynamic_node_list]
            E12[Last_seen timestamp]
            E9 --> E10 --> E11 --> E12 --> E9
        end
    end
    
    D13 --> E
    
    %% ========== 4. TÂCHE SISMIQUE ==========
    subgraph F[SeismicTask - Priorité Haute]
        F1[Attente adcReadySem]
        F1 --> F2[Lecture adc_raw X,Y,Z]
        F2 --> F3[Buffer circulaire idx++]
        
        F3 --> F4[Calcul RMS]
        subgraph F4_Detail[Algorithme RMS]
            F4A[Moyenne 100 échantillons]
            F4B[Variance Σx² - μ²]
            F4C[sqrtvariance / 100]
            F4D[Conversion ADC→Volts: ×3.3/4095]
            F4A --> F4B --> F4C --> F4D
        end
        
        F4 --> F5{Détection?}
        F5 -->|Condition 1: raw > 2500| F6
        F5 -->|Condition 2: RMS > 0.24V| F6
        
        subgraph F6[Alerte Locale]
            F6A[my_alert_status = 1]
            F6B[LED3 ON]
            F6C[Log UART horodaté]
            F6D[Stockage local_history]
            F6A --> F6B --> F6C --> F6D
        end
        
        F6 --> F7{Écriture FRAM?}
        F7 -->|Toutes 2s| F8[FRAM_Write 0x0000]
        F7 -->|Non| F9[Continuer]
        
        F5 -->|NON| F10[Monitoring]
        F10 --> F11{Alerte en cours?}
        F11 -->|OUi| F12[my_alert_status = 0]
        F11 -->|Non| F9
        
        F8 --> F9
        F12 --> F9
        F9 --> F1
    end
    
    E3 --> F
    
    %% ========== 5. RÉSEAU CLIENT/SERVEUR ==========
    subgraph G[Réseau TCP]
        subgraph G1[ServerTask - Écoute]
            G1A[tcp_server_init port 12345]
            G1B[tcp_listen]
            G1C[tcp_accept]
            G1D[Réception data_request]
            G1E[Envoi data_response]
            G1A --> G1B --> G1C --> G1D --> G1E --> G1C
        end
        
        subgraph G2[ClientTask - Scan]
            G2A[Scan dynamic_node_list]
            G2B{Voisin actif?}
            G2B -->|OUI| G2C[Connexion TCP]
            G2B -->|NON| G2D[Delay 5s]
            
            G2C --> G2E[Envoi data_request]
            G2E --> G2F[Attente réponse]
            G2F --> G2G[Réception data_response]
            G2G --> G2H[Mise à jour intelligence]
            
            G2H --> G2I[Delay 200ms]
            G2D --> G2A
            G2I --> G2A
        end
    end
    
    E3 --> G
    
    %% ========== 6. INTELLIGENCE COLLECTIVE ==========
    subgraph H[Intelligence Collective]
        H1[my_alert_status] --> H2{ET Logique}
        H3[neighbor_alert_status] --> H2
        
        H2 -->|VRAI| H4[ALERTE GÉNÉRALE]
        H2 -->|FAUX| H5[État Normal]
        
        H4 --> H6[LED3 Clignotement rapide]
        H5 --> H7[LED3 OFF si alerte finie]
        
        subgraph H8[Historique Pics]
            H9[local_peaks 10 valeurs]
            H10[neighbor_peaks 10 valeurs]
            H11[Index circulaire]
        end
    end
    
    F6 --> H1
    G2H --> H3
    H4 --> I[Sauvegarde événement]
    
    %% ========== 7. MODE PAUSE ==========
    subgraph J[Système Pause - system_is_running = 0]
        J1[Toutes tâches suspendues]
        J2[Lecture FRAM complète]
        
        subgraph J3[Affichage Historique]
            J4[10 derniers événements locaux]
            J5[5 voisins × 10 événements]
            J6[Dates et intensités]
            J7[Affichage via UART]
        end
        
        J2 --> J3
        J3 --> J8[Retour attente bouton]
    end
    
    D14 --> J
    
    %% ========== 8. MÉMOIRE ==========
    subgraph K[Architecture Mémoire]
        subgraph K1[FRAM]
            K1A[adc_raw 3 valeurs]
            K1B[buf_x 100 échantillons]
            K1C[buf_y 100 échantillons]
            K1D[buf_z 100 échantillons]
            K1E[local_history 10 événements]
            K1F[dynamic_node_list 10 voisins]
        end
        
        subgraph K2[FRAM - Non-volatile]
            K2A[0x0000 - SeismicEvent local]
            K2B[0x0100 - Slot Voisin 0]
            K2C[Autres slots 1-4]
            K2D[Structure: 5×10 NeighborEvent]
        end
        
        subgraph K3[UART Pool]
            K3A[uartMsgPool 64 messages]
            K3B[uartMsgPoolIndex pointeur]
            K3C[Protection mutex]
        end
    end
    
    %% ========== 9. INTERRUPTIONS ==========
    subgraph L[Système d'Interruptions]
        L1[HAL_ADC_ConvCpltCallback] --> L2[osSemaphoreRelease]
        L2 --> L3[LED2 Toggle]
        
        L4[presence_recv_cb - UDP] --> L5[MàJ liste voisins]
        L5 --> L6[Update last_seen]
        
        L7[ntp_recv_callback] --> L8[Extraction timestamp]
        L8 --> L9[Conversion NTP→UNIX]
        L9 --> L10[+1h Timezone]
        L10 --> L11[RTC_SetDateTime]
    end
    
    %% ========== 10. CONNECTIONS GLOBALES ==========
    B3 --> L1
    L1 --> F1
    L4 --> E11
    L7 --> D8
    
    F --> H
    G --> H
    H --> I
    I --> K2
    
    E2 --> K2
    J2 --> K2
    
    K --> F
    K --> G
    K --> J3
    
    %% ========== 11. LÉGENDE DÉTAILLÉE ==========
    subgraph M[Légende Système]
        M1[Périphériques Hardware]
        M2[Acquisition & Détection]
        M3[Communication Réseau]
        M4[Intelligence & Logique]
        M5[Mémoire & Stockage]
        M6[États & Modes]
        M7[Interruptions & Events]
    end
    
    %% ========== 12. STATISTIQUES ==========
    subgraph N[Caractéristiques Techniques]
        N1[100Hz - Fréquence échantillonnage]
        N2[100 échantillons - Fenêtre RMS]
        N3[0.24V - Seuil détection RMS]
        N4[10s - Intervalle broadcast]
        N5[12345 - Port TCP/UDP]
        N6[5×10 - Capacité historique]
        N7[DHCP + NTP - Synchronisation]
    end
    
    %% ========== 13. STYLES COMPLETS ==========
    classDef start fill:#2E8B57,stroke:#333,color:#fff,stroke-width:3px
    classDef hardware fill:#4169E1,stroke:#333,color:#fff
    classDef seismic fill:#DC143C,stroke:#333,color:#fff,font-weight:bold
    classDef network fill:#9370DB,stroke:#333,color:#fff
    classDef memory fill:#8B4513,stroke:#333,color:#fff
    classDef decision fill:#FFD700,stroke:#333,color:#000,stroke-width:2px
    classDef alert fill:#FF4500,stroke:#fff,color:#fff,stroke-width:3px
    classDef pause fill:#696969,stroke:#333,color:#fff
    classDef interrupt fill:#32CD32,stroke:#333,color:#000
    classDef legend fill:#F5F5F5,stroke:#333,color:#000
    classDef stats fill:#E6E6FA,stroke:#333,color:#000
    
    class A start
    class B,B1,B2,B3,B4,B5,B6,B7,B8,B9 hardware
    class C2,F,F4_Detail,F6 seismic
    class C3,C4,C5,E4,E8,G,G1,G2 network
    class K,K1,K2,K3 memory
    class D5,D7,D11,F5,F7,F11,H2 decision
    class F6,H4 alert
    class J,J1,J2,J3 pause
    class L,L1,L4,L7 interrupt
    class M legend
    class N stats